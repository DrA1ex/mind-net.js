!function(){"use strict";function t(t,e){const n=Math.max(t.length,e.length),o=new Array(n);for(let r=0;r<n;r++)o[r]=[t[r],e[r]];return o}function e(t,e){return Array.from(function*(t,e){let n=0;for(const o of t)yield e(o,n),n+=1}(function*(t,e){for(let n=0;n<e;++n)yield n}(0,e),t))}function n(t,e,n){const o=Math.min(t.length,e.length),r=new Array(o);for(let s=0;s<o;++s)r[s]=n(t[s],e[s]);return r}function o(t,e){const n=t.length,o=new Array(n);for(let r=0;r<n;++r)o[r]=e(t[r]);return o}function r(t,e){!function(t,e,n){const o=Math.min(t.length,e.length);for(let r=0;r<o;++r)t[r]=t[r]+e[r]}(t,e)}function s(t,e){return o(t,t=>t*e)}function i(t,e){const n=Math.min(t.length,e.length);let o=0,r=0;for(let s=0;s<n;++s){const n=t[s]*e[s]-r,i=o+n;r=i-o-n,o=i}return o}function a(t,n=0,o=1){const r=o-n;return e(()=>n+Math.random()*r,t)}function l(t){return[...t]}function c(t){let e=0;for(let n of t)e+=n;return e}function h(t,e){const n=new Array(t[0].length),o=Math.min(t.length,e.length);for(let r=0;r<n.length;++r){let s=0,i=0;for(let n=0;n<o;n++){const o=t[n][r]*e[n]-i,a=s+o;i=a-s-o,s=a}n[r]=s}return n}class u{constructor(t,n){var o;this.neuronCnt=t,this.prevLayer=n;const r=(null===(o=this.prevLayer)||void 0===o?void 0:o.neuronCnt)||0;this.values=function(t,n){return e(()=>0,n)}(0,this.neuronCnt),r>0?(this.biases=a(this.neuronCnt,-1,1),this.backWeights=function(t,n,o=0,r=1){return e(t=>a(n,o,r),t)}(this.neuronCnt,r)):(this.biases=[],this.backWeights=[])}}class f{constructor(...t){this.layers=new Array(t.length),this.learningRate=.01;for(let e=0;e<t.length;e++)this.layers[e]=new u(t[e],e>0?this.layers[e-1]:void 0)}train(t,e){let i=n(e,this.compute(t),(t,e)=>t-e);for(let a=this.layers.length-2;a>=0;a--){const t=this.layers[a+1],e=this.layers[a],l=s(n(i,o(t.values,t=>t*(1-t)),(t,e)=>t*e),this.learningRate);for(let n=0;n<t.neuronCnt;n++)r(t.backWeights[n],s(e.values,l[n]));r(t.biases,l),null!==e.prevLayer&&(i=h(t.backWeights,i))}}compute(t){let e=this.layers[0];e.values=t;for(let o=1;o<this.layers.length;o++){const t=this.layers[o];for(let o=0;o<t.backWeights.length;o++)t.values[o]=(n=i(t.backWeights[o],e.values)+t.biases[o],1/(1+Math.exp(-n)));e=t}var n;return this.layers[this.layers.length-1].values}getSnapshot(){return{weights:this.layers.slice(1).map(t=>t.backWeights.map(t=>l(t))),biases:this.layers.slice(1).map(t=>l(t.biases))}}}const g=[13,7,5];let y=new f(2,...g,1);y.learningRate=.01;let p=[],m=0,d=0;function v(t=.25){const e=performance.now();if(e-d<41.666666666666664)return;const n=1/640/t,o=1/480/t,r=Math.ceil(1/n),s=Math.ceil(1/o),i=new Uint32Array(r*s);for(let l=0;l<r;l++)for(let t=0;t<s;t++){const e=y.compute([l*n,t*o]);i[t*r+l]=4283957454|(255*e[0]&255)<<8}const a={type:"training_data",iteration:m,state:i.buffer,nnSnapshot:y.getSnapshot(),width:r,height:s,t:performance.now()};d=e,postMessage(a,[i.buffer])}addEventListener("message",({data:t})=>{var e,n;switch(t.type){case"add_point":p.push(t.point),m=0;break;case"set_points":p=t.points,m=0;break;case"refresh":const o=(null===(e=t.config)||void 0===e?void 0:e.layers)||g,r=(null===(n=t.config)||void 0===n?void 0:n.learningRate)||.01;y=new f(2,...o,1),y.learningRate=r,m=0}}),setTimeout(function e(){try{!function(){const e=5e6-m;if(e<=0||0===p.length)return;const n=performance.now(),o=p.map(t=>[[t.x,t.y],[t.type]]);let r;for(r=0;r<e;r++){const t=o[Math.floor(Math.random()*o.length)];if(y.train(t[0],t[1]),r%1e4==0&&performance.now()-n>10.416666666666666)break}m+=r,m>=5e6?(d=0,console.log("*** DATA SET TRAINING FINISHED ***"),function(e,n){if(0===n.length)return;console.log("***");let o=0;for(let r=0;r<n.length;r++){const[s,i]=n[r],a=e.compute(s),l=a.map(t=>t.toFixed(2)),h=i.map(t=>t.toFixed(2)),u=t(i,a).map(([t,e])=>100-100*Math.abs(t-e)),f=u.map(t=>t.toFixed(1));console.log(`INPUT ${s} OUTPUT ${l} EXPECTED ${h} (accuracy ${f}%)`),o+=c(u)}console.log(`TOTAL ACCURACY: ${(o/n.length/n[0][1].length).toFixed(2)}%`),console.log("***")}(y,o),v(2)):v()}()}finally{m<5e6&&p.length>0?setTimeout(e,3):setTimeout(e,1e3)}},0)}();