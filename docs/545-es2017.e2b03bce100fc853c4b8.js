!function(){"use strict";function t(t,e){const n=Math.max(t.length,e.length),r=new Array(n);for(let o=0;o<n;o++)r[o]=[t[o],e[o]];return r}function e(t,e){return Array.from(function*(t,e){let n=0;for(const r of t)yield e(r,n),n+=1}(function*(t,e){for(let n=0;n<e;++n)yield n}(0,e),t))}function n(t,e,n){const r=Math.min(t.length,e.length),o=new Array(r);for(let s=0;s<r;++s)o[s]=n(t[s],e[s]);return o}function r(t,e){const n=t.length,r=new Array(n);for(let o=0;o<n;++o)r[o]=e(t[o]);return r}function o(t,e){!function(t,e,n){const r=Math.min(t.length,e.length);for(let o=0;o<r;++o)t[o]=t[o]+e[o]}(t,e)}function s(t,e){return r(t,t=>t*e)}function i(t,e){const n=Math.min(t.length,e.length);let r=0,o=0;for(let s=0;s<n;++s){const n=t[s]*e[s]-o,i=r+n;o=i-r-n,r=i}return r}function a(t,n=0,r=1){const o=r-n;return e(()=>n+Math.random()*o,t)}function l(t){return[...t]}function c(t){let e=0;for(let n of t)e+=n;return e}function h(t,e){const n=new Array(t[0].length),r=Math.min(t.length,e.length);for(let o=0;o<n.length;++o){let s=0,i=0;for(let n=0;n<r;n++){const r=t[n][o]*e[n]-i,a=s+r;i=a-s-r,s=a}n[o]=s}return n}class u{constructor(t,n){var r;this.neuronCnt=t,this.prevLayer=n;const o=(null===(r=this.prevLayer)||void 0===r?void 0:r.neuronCnt)||0;this.values=function(t,n){return e(()=>0,n)}(0,this.neuronCnt),o>0?(this.biases=a(this.neuronCnt,-1,1),this.backWeights=function(t,n,r=0,o=1){return e(t=>a(n,r,o),t)}(this.neuronCnt,o)):(this.biases=[],this.backWeights=[])}}class f{constructor(...t){this.layers=new Array(t.length),this.learningRate=.01;for(let e=0;e<t.length;e++)this.layers[e]=new u(t[e],e>0?this.layers[e-1]:void 0)}train(t,e){let r=n(e,this.compute(t),(t,e)=>t-e);return this.trainByError(r)}trainByError(t){for(let e=this.layers.length-2;e>=0;e--){const i=this.layers[e+1],a=this.layers[e],l=s(n(t,r(i.values,t=>t*(1-t)),(t,e)=>t*e),this.learningRate);for(let t=0;t<i.neuronCnt;t++)o(i.backWeights[t],s(a.values,l[t]));o(i.biases,l),null!==a.prevLayer&&(t=h(i.backWeights,t))}return t}compute(t){let e=this.layers[0];e.values=t;for(let r=1;r<this.layers.length;r++){const t=this.layers[r];for(let r=0;r<t.backWeights.length;r++)t.values[r]=(n=i(t.backWeights[r],e.values)+t.biases[r],1/(1+Math.exp(-n)));e=t}var n;return this.layers[this.layers.length-1].values}getSnapshot(){return{weights:this.layers.slice(1).map(t=>t.backWeights.map(t=>l(t))),biases:this.layers.slice(1).map(t=>l(t.biases))}}}function g(t){const e=function(t){return[Number.parseInt(t.substr(1,2),16),Number.parseInt(t.substr(3,2),16),Number.parseInt(t.substr(5,2),16)]}(t);return 4278190080|e[2]<<16|e[1]<<8|e[0]}function p(t,e,n){const r=t>>16&255,o=t>>8&255,s=255&t;return((e>>16&255)-r)*(n=Math.max(0,Math.min(1,n)))+r<<16|((e>>8&255)-o)*n+o<<8|((255&e)-s)*n+s|4278190080}const m=[13,7,5],y=g("#e72525"),b=g("#2562e7");let d=new f(2,...m,1);d.learningRate=.01;let v=[],w=0,M=0;function A(t=.25){const e=performance.now();if(e-M<41.666666666666664)return;const n=1/640/t,r=1/480/t,o=Math.ceil(1/n),s=Math.ceil(1/r),i=new Uint32Array(o*s);for(let l=0;l<o;l++)for(let t=0;t<s;t++){const e=d.compute([l*n,t*r]);i[t*o+l]=p(y,b,e[0])}const a={type:"training_data",iteration:w,state:i.buffer,nnSnapshot:d.getSnapshot(),width:o,height:s,t:performance.now()};M=e,postMessage(a,[i.buffer]),console.log(`*** Computing ${(performance.now()-e).toFixed(2)}ms`)}addEventListener("message",({data:t})=>{var e,n;switch(t.type){case"add_point":v.push(t.point),w=0;break;case"set_points":v=t.points,w=0;break;case"refresh":const r=(null===(e=t.config)||void 0===e?void 0:e.layers)||m,o=(null===(n=t.config)||void 0===n?void 0:n.learningRate)||.01;d=new f(2,...r,1),d.learningRate=o,w=0}}),setTimeout(function e(){try{!function(){const e=5e6-w;if(e<=0||0===v.length)return;const n=performance.now(),r=v.map(t=>[[t.x,t.y],[t.type]]);let o;for(o=0;o<e;o++){const t=r[Math.floor(Math.random()*r.length)];if(d.train(t[0],t[1]),o%1e4==0&&performance.now()-n>10.416666666666666)break}w+=o,w>=5e6?(M=0,console.log("*** DATA SET TRAINING FINISHED ***"),function(e,n){if(0===n.length)return;console.log("***");let r=0;for(let o=0;o<n.length;o++){const[s,i]=n[o],a=e.compute(s),l=a.map(t=>t.toFixed(2)),h=i.map(t=>t.toFixed(2)),u=t(i,a).map(([t,e])=>100-100*Math.abs(t-e)),f=u.map(t=>t.toFixed(1));console.log(`INPUT ${s} OUTPUT ${l} EXPECTED ${h} (accuracy ${f}%)`),r+=c(u)}console.log(`TOTAL ACCURACY: ${(r/n.length/n[0][1].length).toFixed(2)}%`),console.log("***")}(d,r),A(2)):A()}()}finally{w<5e6&&v.length>0?setTimeout(e,3):setTimeout(e,1e3)}},0)}();